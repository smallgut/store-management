<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supabase Inventory</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="p-6 bg-gray-100 min-h-screen">
  <h1 class="text-3xl font-bold mb-6">Supabase Inventory Management</h1>

  <!-- Analytics Section -->
  <div class="mb-8">
    <h2 class="text-2xl font-semibold mb-4">Analytics</h2>
    <div id="analytics" class="bg-white p-4 rounded shadow">
      <p>Total Sales Quantity: <span id="total-sales">0</span></p>
      <p>Total Stock Value: $<span id="total-stock-value">0</span></p>
      <canvas id="salesChart" class="mt-4"></canvas>
    </div>
  </div>

  <!-- Products Section -->
  <div class="mb-8">
    <h2 class="text-2xl font-semibold mb-4">Manage Products</h2>
    <form onsubmit="event.preventDefault(); addProduct({ barcode: document.getElementById('barcode').value.trim(), name: document.getElementById('name').value.trim(), price: parseFloat(document.getElementById('price').value), stock: parseInt(document.getElementById('stock').value) })" class="mb-4 space-y-2">
      <input id="barcode" type="text" placeholder="Barcode" required class="border p-2 rounded">
      <input id="name" type="text" placeholder="Name" required class="border p-2 rounded">
      <input id="price" type="number" step="0.01" min="0" placeholder="Price" required class="border p-2 rounded">
      <input id="stock" type="number" min="0" placeholder="Stock" required class="border p-2 rounded">
      <button type="submit" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Add Product</button>
    </form>
    <form onsubmit="event.preventDefault(); updateProduct(document.getElementById('edit-barcode').value.trim(), { name: document.getElementById('edit-name').value.trim(), price: parseFloat(document.getElementById('edit-price').value), stock: parseInt(document.getElementById('edit-stock').value) })" class="mb-4 space-y-2">
      <input id="edit-barcode" type="text" placeholder="Barcode" required class="border p-2 rounded">
      <input id="edit-name" type="text" placeholder="Name" required class="border p-2 rounded">
      <input id="edit-price" type="number" step="0.01" min="0" placeholder="Price" required class="border p-2 rounded">
      <input id="edit-stock" type="number" min="0" placeholder="Stock" required class="border p-2 rounded">
      <button type="submit" class="bg-yellow-500 text-white p-2 rounded hover:bg-yellow-600">Update Product</button>
    </form>
    <p class="text-gray-600 text-sm mb-2">Note: Barcodes must be unique.</p>
    <button onclick="sortProducts('price')" class="bg-gray-300 p-2 rounded mr-2 hover:bg-gray-400">Sort by Price</button>
    <button onclick="sortProducts('stock')" class="bg-gray-300 p-2 rounded hover:bg-gray-400">Sort by Stock</button>
    <table id="products" class="w-full border-collapse mt-4 bg-white shadow">
      <thead>
        <tr class="bg-gray-200">
          <th class="border p-2">Name</th>
          <th class="border p-2">Barcode</th>
          <th class="border p-2">Price</th>
          <th class="border p-2">Stock</th>
          <th class="border p-2">Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Vendors Section -->
  <div class="mb-8">
    <h2 class="text-2xl font-semibold mb-4">Manage Vendors</h2>
    <form onsubmit="event.preventDefault(); addVendor({ name: document.getElementById('vendor-name').value.trim(), contact_email: document.getElementById('vendor-email').value.trim() })" class="mb-4 space-y-2">
      <input id="vendor-name" type="text" placeholder="Vendor Name" required class="border p-2 rounded">
      <input id="vendor-email" type="email" placeholder="Contact Email" class="border p-2 rounded">
      <button type="submit" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Add Vendor</button>
    </form>
    <form onsubmit="event.preventDefault(); updateVendor(parseInt(document.getElementById('edit-vendor-id').value), { name: document.getElementById('edit-vendor-name').value.trim(), contact_email: document.getElementById('edit-vendor-email').value.trim() })" class="mb-4 space-y-2">
      <input id="edit-vendor-id" type="number" placeholder="Vendor ID" required class="border p-2 rounded">
      <input id="edit-vendor-name" type="text" placeholder="Vendor Name" required class="border p-2 rounded">
      <input id="edit-vendor-email" type="email" placeholder="Contact Email" class="border p-2 rounded">
      <button type="submit" class="bg-yellow-500 text-white p-2 rounded hover:bg-yellow-600">Update Vendor</button>
    </form>
    <p class="text-gray-600 text-sm mb-2">Note: Vendor names must be unique.</p>
    <table id="vendors" class="w-full border-collapse mt-4 bg-white shadow">
      <thead>
        <tr class="bg-gray-200">
          <th class="border p-2">Name</th>
          <th class="border p-2">Contact Email</th>
          <th class="border p-2">Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Sales Section -->
  <div class="mb-8">
    <h2 class="text-2xl font-semibold mb-4">Record Sales</h2>
    <form onsubmit="event.preventDefault(); addSale({ product_barcode: document.getElementById('sale-barcode').value.trim(), vendor_id: parseInt(document.getElementById('sale-vendor').value), quantity: parseInt(document.getElementById('sale-quantity').value) })" class="mb-4 space-y-2">
      <input id="sale-barcode" type="text" placeholder="Product Barcode" required class="border p-2 rounded">
      <select id="sale-vendor" required class="border p-2 rounded">
        <option value="">Select Vendor</option>
      </select>
      <input id="sale-quantity" type="number" min="1" placeholder="Quantity" required class="border p-2 rounded">
      <button type="submit" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Record Sale</button>
    </form>
    <table id="sales" class="w-full border-collapse mt-4 bg-white shadow">
      <thead>
        <tr class="bg-gray-200">
          <th class="border p-2">Product</th>
          <th class="border p-2">Vendor</th>
          <th class="border p-2">Quantity</th>
          <th class="border p-2">Date</th>
          <th class="border p-2">Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="message" class="text-green-600 mb-4"></div>
  <div id="error" class="text-red-600 mb-4"></div>
  <div id="loading" class="text-blue-600 mb-4"></div>

  <!-- Load Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <!-- Load Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Clear message after timeout
    function clearMessage(type = 'error') {
      setTimeout(() => {
        document.getElementById(type).textContent = '';
      }, 5000);
    }

    // Set loading state
    function setLoading(isLoading) {
      document.getElementById('loading').textContent = isLoading ? 'Loading...' : '';
    }

    // Initialize Supabase client
    if (typeof supabase === 'undefined') {
      console.error('Supabase SDK not loaded');
      throw new Error('Supabase SDK not loaded');
    }

    const { createClient } = supabase;
    window.supabaseClient = createClient(
      'https://aouduygmcspiqauhrabx.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFvdWR1eWdtY3NwaXFhdWhyYWJ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUyNTM5MzAsImV4cCI6MjA2MDgyOTkzMH0.s8WMvYdE9csSb1xb6jv84aiFBBU_LpDi1aserTQDg-k'
    );
    console.log('Supabase Client Initialized:', Object.keys(window.supabaseClient));

    // Test Supabase connection
    async function testSupabase() {
      if (!window.supabaseClient) {
        console.error('Supabase client not initialized');
        return;
      }
      console.log('Supabase client is ready:', Object.keys(window.supabaseClient));
    }

    // Initialize Chart.js
    let salesChartInstance = null;
    async function updateSalesChart() {
      try {
        const { data: sales } = await window.supabaseClient
          .from('sales')
          .select('product_barcode, quantity')
          .order('sale_date');
        const { data: products } = await window.supabaseClient
          .from('products')
          .select('barcode, name');
        const salesByProduct = {};
        sales.forEach(s => {
          const productName = products.find(p => p.barcode === s.product_barcode)?.name || s.product_barcode;
          salesByProduct[productName] = (salesByProduct[productName] || 0) + s.quantity;
        });
        const labels = Object.keys(salesByProduct);
        const data = Object.values(salesByProduct);

        if (salesChartInstance) {
          salesChartInstance.destroy();
        }

        const ctx = document.getElementById('salesChart').getContext('2d');
        salesChartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Sales Quantity by Product',
              data: data,
              backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'],
              borderColor: ['#1e40af', '#047857', '#b45309', '#b91c1c', '#5b21b6', '#be185d'],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: { beginAtZero: true, title: { display: true, text: 'Quantity Sold' } },
              x: { title: { display: true, text: 'Product' } }
            }
          }
        });
      } catch (error) {
        console.error('Error updating sales chart:', error.message);
      }
    }

    // Update analytics
    async function updateAnalytics() {
      try {
        const { data: sales } = await window.supabaseClient.from('sales').select('quantity');
        const { data: products } = await window.supabaseClient.from('products').select('price, stock');
        const totalSales = sales.reduce((sum, s) => sum + s.quantity, 0);
        const totalStockValue = products.reduce((sum, p) => sum + p.price * p.stock, 0).toFixed(2);
        document.getElementById('total-sales').textContent = totalSales;
        document.getElementById('total-stock-value').textContent = totalStockValue;
        updateSalesChart();
      } catch (error) {
        console.error('Error updating analytics:', error.message);
      }
    }

    // Load products
    async function loadProducts() {
      if (!window.supabaseClient) {
        console.error('Supabase client not initialized');
        return;
      }
      setLoading(true);
      try {
        const { data, error } = await window.supabaseClient.from('products').select('*');
        if (error) throw error;
        console.log('Products:', data);
        const productsBody = document.querySelector('#products tbody');
        productsBody.innerHTML = data.length
          ? data.map(p => `
              <tr>
                <td class="border p-2">${p.name}</td>
                <td class="border p-2">${p.barcode}</td>
                <td class="border p-2">$${p.price}</td>
                <td class="border p-2">${p.stock}</td>
                <td class="border p-2">
                  <button onclick="updateProduct('${p.barcode}', { stock: ${p.stock + 10} })" class="bg-green-500 text-white p-1 rounded hover:bg-green-600">Increase Stock (+10)</button>
                  <button onclick="if (confirm('Delete ${p.name} (${p.barcode})?')) deleteProduct('${p.barcode}')" class="bg-red-500 text-white p-1 rounded hover:bg-red-600">Delete</button>
                </td>
              </tr>
            `).join('')
          : '<tr><td colspan="5" class="border p-2">No products found.</td></tr>';
        updateAnalytics();
      } catch (error) {
        console.error('Error loading products:', error.message);
        document.getElementById('error').textContent = `[${new Date().toISOString()}] Failed to load products: ${error.message}`;
        clearMessage('error');
      } finally {
        setLoading(false);
      }
    }

    // Load vendors
    async function loadVendors() {
      if (!window.supabaseClient) {
        console.error('Supabase client not initialized');
        return;
      }
      setLoading(true);
      try {
        const { data, error } = await window.supabaseClient.from('vendors').select('*');
        if (error) throw error;
        console.log('Vendors:', data);
        const vendorsBody = document.querySelector('#vendors tbody');
        vendorsBody.innerHTML = data.length
          ? data.map(v => `
              <tr>
                <td class="border p-2">${v.name}</td>
                <td class="border p-2">${v.contact_email || '-'}</td>
                <td class="border p-2">
                  <button onclick="if (confirm('Delete ${v.name}?')) deleteVendor(${v.id})" class="bg-red-500 text-white p-1 rounded hover:bg-red-600">Delete</button>
                </td>
              </tr>
            `).join('')
          : '<tr><td colspan="3" class="border p-2">No vendors found.</td></tr>';
        const vendorSelect = document.getElementById('sale-vendor');
        vendorSelect.innerHTML = '<option value="">Select Vendor</option>' + data.map(v => `<option value="${v.id}">${v.name}</option>`).join('');
      }σο

System: I notice that the provided `index.html` artifact is incomplete, as it cuts off in the middle of the `loadVendors` function. To ensure you have a fully functional app, I’ll provide the complete updated `index.html` with the fixed `addSale` validation, analytics, and sales trend chart. I’ll also address the invalid barcode issue (`12341234A`), guide you to clean up the Supabase data, and outline steps to test everything thoroughly. Since the Chrome promise error (`i18next`) wasn’t mentioned in the latest console output, I’ll assume it’s either resolved or still harmless, but I’ll include steps to debug it if it persists.

### Analysis of Console Output
- **Successful Sales**:
  - Sale 1: `product_barcode: '12341234', vendor_id: 1, quantity: 2` (valid, for `carrot`, stock 20 → 18).
  - Sale 2: `product_barcode: '12341234A', vendor_id: 1, quantity: 1` (invalid, should not have been added).
- **Invalid Barcode Test**:
  - `12341234Avvv` correctly failed with `406 Not Acceptable` and `Error adding sale: Product not found`.
- **Issue**:
  - The `12341234A` sale bypassed validation, despite the foreign key constraint (`fk_product`) on `sales.product_barcode`. This suggests the constraint wasn’t enforced or the client-side validation in `addSale` is flawed.
- **Real-Time Updates**:
  - `products` table updated for both sales, but the `12341234A` update is incorrect (no matching product).

### Action Items

#### 1. Clean Up Invalid Sale in Supabase
Remove the invalid sale (`id: 2, product_barcode: '12341234A'`) to maintain data integrity.

**Steps**:
- In Supabase **SQL Editor**, run:
  ```sql
  DELETE FROM sales WHERE id = 2;
  ```
- Verify in **Table Editor > sales**:
  - Only `id: 1, product_barcode: '12341234', vendor_id: 1, quantity: 2` remains.
- Check `products` stock:
  ```sql
  SELECT barcode, name, stock FROM products WHERE barcode = '12341234';
  ```
- Expected: `barcode: '12341234', name: 'carrot', stock: 18`.
- If stock is incorrect (e.g., 19 due to `12341234A`), fix it:
  ```sql
  UPDATE products SET stock = 18 WHERE barcode = '12341234';
  ```
- Share a screenshot of **Table Editor > sales** and **Table Editor > products** if issues persist.

#### 2. Verify Foreign Key Constraint
Ensure the `sales` table’s foreign key constraint is active.

**Steps**:
- In **SQL Editor**, run:
  ```sql
  \d sales
  ```
- Confirm:
  ```
  Constraints:
      "fk_product" FOREIGN KEY (product_barcode) REFERENCES products(barcode) ON DELETE RESTRICT
      "fk_vendor" FOREIGN KEY (vendor_id) REFERENCES vendors(id) ON DELETE RESTRICT
  ```
- If missing, recreate the `sales` table:
  <xaiArtifact artifact_id="99aa9e50-c203-4aa4-a80b-7237f0475954" artifact_version_id="536e2659-92cc-477c-88bc-601e64fb602a" title="supabase_schema_fix.sql" contentType="text/sql">
  -- Drop sales table
  DROP TABLE IF EXISTS sales CASCADE;

  -- Recreate sales
  CREATE TABLE sales (
    id SERIAL PRIMARY KEY,
    product_barcode TEXT NOT NULL,
    vendor_id INTEGER NOT NULL,
    quantity INTEGER NOT NULL CHECK (quantity > 0),
    sale_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_product FOREIGN KEY (product_barcode) REFERENCES products(barcode) ON DELETE RESTRICT,
    CONSTRAINT fk_vendor FOREIGN KEY (vendor_id) REFERENCES vendors(id) ON DELETE RESTRICT
  );

  -- Enable RLS for sales
  ALTER TABLE sales ENABLE ROW LEVEL SECURITY;
  CREATE POLICY "Allow public read sales" ON sales FOR SELECT USING (true);
  CREATE POLICY "Allow public insert sales" ON sales FOR INSERT WITH CHECK (true);
  CREATE POLICY "Allow public update sales" ON sales FOR UPDATE USING (true);
  CREATE POLICY "Allow public delete sales" ON sales FOR DELETE USING (true);

  -- Reinsert valid sale
  INSERT INTO sales (product_barcode, vendor_id, quantity, sale_date)
  VALUES ('12341234', 1, 2, '2025-05-24T23:27:28.397347');
