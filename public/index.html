<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supabase Inventory</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="p-6 bg-gray-100 min-h-screen">
  <h1 class="text-3xl font-bold mb-6">Supabase Inventory Management</h1>

  <!-- Analytics Section -->
  <div class="mb-8">
    <h2 class="text-2xl font-semibold mb-4">Analytics</h2>
    <div id="analytics" class="bg-white p-4 rounded shadow">
      <p>Total Sales Quantity: <span id="total-sales">0</span></p>
      <p>Total Stock Value: $<span id="total-stock-value">0</span></p>
      <canvas id="salesChart" class="mt-4"></canvas>
    </div>
  </div>

  <!-- Products Section -->
  <div class="mb-8">
    <h2 class="text-2xl font-semibold mb-4">Manage Products</h2>
    <form onsubmit="event.preventDefault(); addProduct({ barcode: document.getElementById('barcode').value.trim(), name: document.getElementById('name').value.trim(), price: parseFloat(document.getElementById('price').value), stock: parseInt(document.getElementById('stock').value) })" class="mb-4 space-y-2">
      <input id="barcode" type="text" placeholder="Barcode" required class="border p-2 rounded">
      <input id="name" type="text" placeholder="Name" required class="border p-2 rounded">
      <input id="price" type="number" step="0.01" min="0" placeholder="Price" required class="border p-2 rounded">
      <input id="stock" type="number" min="0" placeholder="Stock" required class="border p-2 rounded">
      <button type="submit" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Add Product</button>
    </form>
    <form onsubmit="event.preventDefault(); updateProduct(document.getElementById('edit-barcode').value.trim(), { name: document.getElementById('edit-name').value.trim(), price: parseFloat(document.getElementById('edit-price').value), stock: parseInt(document.getElementById('edit-stock').value) })" class="mb-4 space-y-2">
      <input id="edit-barcode" type="text" placeholder="Barcode" required class="border p-2 rounded">
      <input id="edit-name" type="text" placeholder="Name" required class="border p-2 rounded">
      <input id="edit-price" type="number" step="0.01" min="0" placeholder="Price" required class="border p-2 rounded">
      <input id="edit-stock" type="number" min="0" placeholder="Stock" required class="border p-2 rounded">
      <button type="submit" class="bg-yellow-500 text-white p-2 rounded hover:bg-yellow-600">Update Product</button>
    </form>
    <p class="text-gray-600 text-sm mb-2">Note: Barcodes must be unique.</p>
    <button onclick="sortProducts('price')" class="bg-gray-300 p-2 rounded mr-2 hover:bg-gray-400">Sort by Price</button>
    <button onclick="sortProducts('stock')" class="bg-gray-300 p-2 rounded hover:bg-gray-400">Sort by Stock</button>
    <table id="products" class="w-full border-collapse mt-4 bg-white shadow">
      <thead>
        <tr class="bg-gray-200">
          <th class="border p-2">Name</th>
          <th class="border p-2">Barcode</th>
          <th class="border p-2">Price</th>
          <th class="border p-2">Stock</th>
          <th class="border p-2">Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Vendors Section -->
  <div class="mb-8">
    <h2 class="text-2xl font-semibold mb-4">Manage Vendors</h2>
    <form onsubmit="event.preventDefault(); addVendor({ name: document.getElementById('vendor-name').value.trim(), contact_email: document.getElementById('vendor-email').value.trim() })" class="mb-4 space-y-2">
      <input id="vendor-name" type="text" placeholder="Vendor Name" required class="border p-2 rounded">
      <input id="vendor-email" type="email" placeholder="Contact Email" class="border p-2 rounded">
      <button type="submit" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Add Vendor</button>
    </form>
    <form onsubmit="event.preventDefault(); updateVendor(parseInt(document.getElementById('edit-vendor-id').value), { name: document.getElementById('edit-vendor-name').value.trim(), contact_email: document.getElementById('edit-vendor-email').value.trim() })" class="mb-4 space-y-2">
      <input id="edit-vendor-id" type="number" placeholder="Vendor ID" required class="border p-2 rounded">
      <input id="edit-vendor-name" type="text" placeholder="Vendor Name" required class="border p-2 rounded">
      <input id="edit-vendor-email" type="email" placeholder="Contact Email" class="border p-2 rounded">
      <button type="submit" class="bg-yellow-500 text-white p-2 rounded hover:bg-yellow-600">Update Vendor</button>
    </form>
    <p class="text-gray-600 text-sm mb-2">Note: Vendor names must be unique.</p>
    <table id="vendors" class="w-full border-collapse mt-4 bg-white shadow">
      <thead>
        <tr class="bg-gray-200">
          <th class="border p-2">Name</th>
          <th class="border p-2">Contact Email</th>
          <th class="border p-2">Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Sales Section -->
  <div class="mb-8">
    <h2 class="text-2xl font-semibold mb-4">Record Sales</h2>
    <form onsubmit="event.preventDefault(); addSale({ product_barcode: document.getElementById('sale-barcode').value.trim(), vendor_id: parseInt(document.getElementById('sale-vendor').value), quantity: parseInt(document.getElementById('sale-quantity').value) })" class="mb-4 space-y-2">
      <input id="sale-barcode" type="text" placeholder="Product Barcode" required class="border p-2 rounded">
      <select id="sale-vendor" required class="border p-2 rounded">
        <option value="">Select Vendor</option>
      </select>
      <input id="sale-quantity" type="number" min="1" placeholder="Quantity" required class="border p-2 rounded">
      <button type="submit" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Record Sale</button>
    </form>
    <table id="sales" class="w-full border-collapse mt-4 bg-white shadow">
      <thead>
        <tr class="bg-gray-200">
          <th class="border p-2">Product</th>
          <th class="border p-2">Vendor</th>
          <th class="border p-2">Quantity</th>
          <th class="border p-2">Date</th>
          <th class="border p-2">Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="message" class="text-green-600 mb-4"></div>
  <div id="error" class="text-red-600 mb-4"></div>
  <div id="loading" class="text-blue-600 mb-4 hidden">
    <svg class="animate-spin h-5 w-5 inline-block mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    Loading...
  </div>

  <!-- Load Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <!-- Load Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Clear message after timeout
    function clearMessage(type = 'error') {
      setTimeout(() => {
        document.getElementById(type).textContent = '';
      }, 5000);
    }

    // Set loading state
    function setLoading(isLoading) {
      const loadingEl = document.getElementById('loading');
      loadingEl.classList.toggle('hidden', !isLoading);
    }

    // Debounce function
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Initialize Supabase client
    if (typeof supabase === 'undefined') {
      console.error('Supabase SDK not loaded');
      throw new Error('Supabase SDK not loaded');
    }

    const { createClient } = supabase;
    window.supabaseClient = createClient(
      'https://aouduygmcspiqauhrabx.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFvdWR1eWdtY3NwaXFhdWhyYWJ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUyNTM5MzAsImV4cCI6MjA2MDgyOTkzMH0.s8WMvYdE9csSb1xb6jv84aiFBBU_LpDi1aserTQDg-k'
    );
    console.log('Supabase Client Initialized:', Object.keys(window.supabaseClient));

    // Test Supabase connection
    async function testSupabase() {
      if (!window.supabaseClient) {
        console.error('Supabase client not initialized');
        return;
      }
      console.log('Supabase client is ready:', Object.keys(window.supabaseClient));
    }

    // Initialize Chart.js
    let salesChartInstance = null;
    async function updateSalesChart() {
      try {
        const { data: sales } = await window.supabaseClient
          .from('sales')
          .select('product_barcode, quantity')
          .order('sale_date');
        const { data: products } = await window.supabaseClient
          .from('products')
          .select('barcode, name');
        const salesByProduct = {};
        sales.forEach(s => {
          const productName = products.find(p => p.barcode === s.product_barcode)?.name || s.product_barcode;
          salesByProduct[productName] = (salesByProduct[productName] || 0) + s.quantity;
        });
        const labels = Object.keys(salesByProduct);
        const data = Object.values(salesByProduct);

        if (salesChartInstance) {
          salesChartInstance.destroy();
        }

        const ctx = document.getElementById('salesChart').getContext('2d');
        salesChartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Sales Quantity by Product',
              data: data,
              backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'],
              borderColor: ['#1e40af', '#047857', '#b45309', '#b91c1c', '#5b21b6', '#be185d'],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: { beginAtZero: true, title: { display: true, text: 'Quantity Sold' } },
              x: { title: { display: true, text: 'Product' } }
            }
          }
        });
      } catch (error) {
        console.error('Error updating sales chart:', error.message);
      }
    }

    // Update analytics
    async function updateAnalytics() {
      try {
        const { data: sales } = await window.supabaseClient.from('sales').select('quantity');
        const { data: products } = await window.supabaseClient.from('products').select('price, stock');
        const totalSales = sales.reduce((sum, s) => sum + s.quantity, 0);
        const totalStockValue = products.reduce((sum, p) => sum + p.price * p.stock, 0).toFixed(2);
        document.getElementById('total-sales').textContent = totalSales;
        document.getElementById('total-stock-value').textContent = totalStockValue;
        await updateSalesChart();
      } catch (error) {
        console.error('Error updating analytics:', error.message);
      }
    }

    // Load products
    async function loadProducts() {
      if (!window.supabaseClient) {
        console.error('Supabase client not initialized');
        return;
      }
      setLoading(true);
      try {
        const { data, error } = await window.supabaseClient.from('products').select('*');
        if (error) throw error;
        console.log('Products:', data);
        const productsBody = document.querySelector('#products tbody');
        productsBody.innerHTML = data.length
          ? data.map(p => `
              <tr>
                <td class="border p-2">${p.name}</td>
                <td class="border p-2">${p.barcode}</td>
                <td class="border p-2">$${p.price.toFixed(2)}</td>
                <td class="border p-2">${p.stock}</td>
                <td class="border p-2">
                  <button onclick="updateProduct('${p.barcode}', { stock: ${p.stock + 10} })" class="bg-green-500 text-white p-1 rounded hover:bg-green-600">Increase Stock (+10)</button>
                  <button onclick="if (confirm('Delete ${p.name} (${p.barcode})?')) deleteProduct('${p.barcode}')" class="bg-red-500 text-white p-1 rounded hover:bg-red-600">Delete</button>
                </td>
              </tr>
            `).join('')
          : '<tr><td colspan="5" class="border p-2">No products found.</td></tr>';
        await updateAnalytics();
      } catch (error) {
        console.error('Error loading products:', error.message);
        document.getElementById('error').textContent = `[${new Date().toISOString()}] Failed to load products: ${error.message}`;
        clearMessage('error');
      } finally {
        setLoading(false);
      }
    }

    // Load vendors (debounced)
    const loadVendors = debounce(async function() {
      if (!window.supabaseClient) {
        console.error('Supabase client not initialized');
        return;
      }
      setLoading(true);
      try {
        const { data, error } = await window.supabaseClient.from('vendors').select('*');
        if (error) throw error;
        console.log('Vendors:', data);
        const vendorsBody = document.querySelector('#vendors tbody');
        vendorsBody.innerHTML = data.length
          ? data.map(v => `
              <tr>
                <td class="border p-2">${v.name}</td>
                <td class="border p-2">${v.contact_email || '-'}</td>
                <td class="border p-2">
                  <button onclick="if (confirm('Delete ${v.name}?')) deleteVendor(${v.id})" class="bg-red-500 text-white p-1 rounded hover:bg-red-600">Delete</button>
                </td>
              </tr>
            `).join('')
          : '<tr><td colspan="3" class="border p-2">No vendors found.</td></tr>';
        const vendorSelect = document.getElementById('sale-vendor');
        vendorSelect.innerHTML = '<option value="">Select Vendor</option>' + data.map(v => `<option value="${v.id}">${v.name}</option>`).join('');
      } catch (error) {
        console.error('Error loading vendors:', error.message);
        document.getElementById('error').textContent = `[${new Date().toISOString()}] Failed to load vendors: ${error.message}`;
        clearMessage('error');
      } finally {
        setLoading(false);
      }
    }, 300);

    // Load sales (debounced)
    const loadSales = debounce(async function() {
      if (!window.supabaseClient) {
        console.error('Supabase client not initialized');
        return;
      }
      setLoading(true);
      try {
        const { data: sales, error } = await window.supabaseClient
          .from('sales')
          .select('id, product_barcode, vendor_id, quantity, sale_date')
          .order('sale_date', { ascending: false });
        if (error) throw error;
        const productBarcodes = [...new Set(sales.map(s => s.product_barcode))];
        const vendorIds = [...new Set(sales.map(s => s.vendor_id))];
        const { data: products } = await window.supabaseClient
          .from('products')
          .select('barcode, name')
          .in('barcode', productBarcodes);
        const { data: vendors } = await window.supabaseClient
          .from('vendors')
          .select('id, name')
          .in('id', vendorIds);
        const salesWithNames = sales.map(s => ({
          ...s,
          product_name: products.find(p => p.barcode === s.product_barcode)?.name || 'Unknown',
          vendor_name: vendors.find(v => v.id === s.vendor_id)?.name || 'Unknown'
        }));
        console.log('Sales:', salesWithNames);
        const salesBody = document.querySelector('#sales tbody');
        salesBody.innerHTML = salesWithNames.length
          ? salesWithNames.map(s => `
              <tr>
                <td class="border p-2">${s.product_name}</td>
                <td class="border p-2">${s.vendor_name}</td>
                <td class="border p-2">${s.quantity}</td>
                <td class="border p-2">${new Date(s.sale_date).toLocaleString()}</td>
                <td class="border p-2">
                  <button onclick="if (confirm('Delete sale for ${s.product_name}?')) deleteSale(${s.id})" class="bg-red-500 text-white p-1 rounded hover:bg-red-600">Delete</button>
                </td>
              </tr>
            `).join('')
          : '<tr><td colspan="5" class="border p-2">No sales found.</td></tr>';
        await updateAnalytics();
      } catch (error) {
        console.error('Error loading sales:', error.message);
        document.getElementById('error').textContent = `[${new Date().toISOString()}] Failed to load sales: ${error.message}`;
        clearMessage('error');
      } finally {
        setLoading(false);
      }
    }, 300);

    // Sort products
    async function sortProducts(by) {
      if (!window.supabaseClient) {
        console.error('Supabase client not initialized');
        return;
      }
      setLoading(true);
      try {
        const { data, error } = await window.supabaseClient.from('products').select('*').order(by);
        if (error) throw error;
        console.log('Sorted products:', data);
        const productsBody = document.querySelector('#products tbody');
        productsBody.innerHTML = data.length
          ? data.map(p => `
              <tr>
                <td class="border p-2">${p.name}</td>
                <td class="border p-2">${p.barcode}</td>
                <td class="border p-2">$${p.price.toFixed(2)}</td>
                <td class="border p-2">${p.stock}</td>
                <td class="border p-2">
                  <button onclick="updateProduct('${p.barcode}', { stock: ${p.stock + 10} })" class="bg-green-500 text-white p-1 rounded hover:bg-green-600">Increase Stock (+10)</button>
                  <button onclick="if (confirm('Delete ${p.name} (${p.barcode})?')) deleteProduct('${p.barcode}')" class="bg-red-500 text-white p-1 rounded hover:bg-red-600">Delete</button>
                </td>
              </tr>
            `).join('')
          : '<tr><td colspan="5" class="border p-2">No products found.</td></tr>';
      } catch (error) {
        console.error('Error sorting products:', error.message);
        document.getElementById('error').textContent = `[${new Date().toISOString()}] Error sorting products: ${error.message}`;
        clearMessage('error');
      } finally {
        setLoading(false);
      }
    }

    // Add product
    async function addProduct(product) {
      if (!window.supabaseClient) {
        console.error('Supabase client not initialized');
        return;
      }
      if (!product.barcode || !product.name) {
        document.getElementById('error').textContent = `[${new Date().toISOString()}] Barcode and name cannot be empty.`;
        clearMessage('error');
        return;
      }
      if (product.price < 0 || product.stock < 0) {
        document.getElementById('error').textContent = `[${new Date().toISOString()}] Price and stock must be non-negative.`;
        clearMessage('error');
        return;
      }
      console.log('Adding product:', product);
      setLoading(true);
      try {
        const { data: existing } = await window.supabaseClient
          .from('products')
          .select('barcode')
          .eq('barcode', product.barcode);
        if (existing.length > 0) throw new Error('Barcode already exists');
        const { data, error } = await window.supabaseClient
          .from('products')
          .insert([product])
          .select();
        if (error) throw error;
        console.log('Product added:', JSON.stringify(data, null, 2));
        document.getElementById('message').textContent = `[${new Date().toISOString()}] Product added: ${product.name}`;
        clearMessage('message');
        await loadProducts();
      } catch (error) {
        console.error('Error adding product:', error.message);
        let errorMessage = `[${new Date().toISOString()}] Failed to add product: ${error.message}`;
        if (error.message.includes('duplicate key value') || error.message.includes('Barcode already exists')) {
          errorMessage = `[${new Date().toISOString()}] Failed to add product: Barcode already exists.`;
        }
        document.getElementById('error').textContent = errorMessage;
        clearMessage('error');
      } finally {
        setLoading(false);
      }
    }

    // Update product
    async function updateProduct(barcode, updates) {
      if (!window.supabaseClient) {
        console.error('Supabase client not initialized');
        return;
      }
      if (!barcode || !updates.name) {
        document.getElementById('error').textContent = `[${new Date().toISOString()}] Barcode and name cannot be empty.`;
        clearMessage('error');
        return;
      }
      if (updates.price < 0 || updates.stock < 0) {
        document.getElementById('error').textContent = `[${new Date().toISOString()}] Price and stock must be non-negative.`;
        clearMessage('error');
        return;
      }
      console.log('Updating product:', barcode, updates);
      setLoading(true);
      try {
        const { data, error } = await window.supabaseClient
          .from('products')
          .update(updates)
          .eq('barcode', barcode)
          .select();
        if (error) throw error;
        if (!data.length) throw new Error('Product not found');
        console.log('Product updated:', JSON.stringify(data, null, 2));
        document.getElementById('message').textContent = `[${new Date().toISOString()}] Product updated: ${barcode}`;
        clearMessage('message');
        await loadProducts();
      } catch (error) {
        console.error('Error updating product:', error.message);
        document.getElementById('error').textContent = `[${new Date().toISOString()}] Error updating product: ${error.message}`;
        clearMessage('error');
      } finally {
        setLoading(false);
      }
    }

    // Delete product
    async function deleteProduct(barcode) {
      if (!window.supabaseClient) {
        console.error('Supabase client not initialized');
        return;
      }
      console.log('Deleting product:', barcode);
      setLoading(true);
      try {
        const { error } = await window.supabaseClient
          .from('products')
          .delete()
          .eq('barcode', barcode);
        if (error) throw error;
        console.log('Product deleted:', barcode);
        document.getElementById('message').textContent = `[${new Date().toISOString()}] Product deleted: ${barcode}`;
        clearMessage('message');
        await loadProducts();
      } catch (error) {
        console.error('Error deleting product:', error.message);
        document.getElementById('error').textContent = `[${new Date().toISOString()}] Error deleting product: ${error.message}`;
        clearMessage('error');
      } finally {
        setLoading(false);
      }
    }

    // Add vendor
    async function addVendor(vendor) {
      if (!window.supabaseClient) {
        console.error('Supabase client not initialized');
        return;
      }
      if (!vendor.name) {
        document.getElementById('error').textContent = `[${new Date().toISOString()}] Vendor name cannot be empty.`;
        clearMessage('error');
        return;
      }
      console.log('Adding vendor:', vendor);
      setLoading(true);
      try {
        const { data: existing } = await window.supabaseClient
          .from('vendors')
          .select('name')
          .eq('name', vendor.name);
        if (existing.length > 0) throw new Error('Vendor name already exists');
        const { data, error } = await window.supabaseClient
          .from('vendors')
          .insert([vendor])
          .select();
        if (error) throw error;
        console.log('Vendor added:', JSON.stringify(data, null, 2));
        document.getElementById('message').textContent = `[${new Date().toISOString()}] Vendor added: ${vendor.name}`;
        clearMessage('message');
        await loadVendors();
      } catch (error) {
        console.error('Error adding vendor:', error.message);
        let errorMessage = `[${new Date().toISOString()}] Failed to add vendor: ${error.message}`;
        if (error.message.includes('duplicate key value') || error.message.includes('Vendor name already exists')) {
          errorMessage = `[${new Date().toISOString()}] Failed to add vendor: Vendor name already exists.`;
        }
        document.getElementById('error').textContent = errorMessage;
        clearMessage('error');
      } finally {
        setLoading(false);
      }
    }

    // Update vendor
    async function updateVendor(id, updates) {
      if (!window.supabaseClient) {
        console.error('Supabase client not initialized');
        return;
      }
      if (!id || !updates.name) {
        document.getElementById('error').textContent = `[${new Date().toISOString()}] Vendor ID and name cannot be empty.`;
        clearMessage('error');
        return;
      }
      console.log('Updating vendor:', id, updates);
      setLoading(true);
      try {
        const { data: existing } = await window.supabaseClient
          .from('vendors')
          .select('id')
          .eq('name', updates.name)
          .neq('id', id);
        if (existing.length > 0) throw new Error('Vendor name already exists');
        const { data, error } = await window.supabaseClient
          .from('vendors')
          .update(updates)
          .eq('id', id)
          .select();
        if (error) throw error;
        if (!data.length) throw new Error('Vendor not found');
        console.log('Vendor updated:', JSON.stringify(data, null, 2));
        document.getElementById('message').textContent = `[${new Date().toISOString()}] Vendor updated: ${updates.name}`;
        clearMessage('message');
        await loadVendors();
      } catch (error) {
        console.error('Error updating vendor:', error.message);
        document.getElementById('error').textContent = `[${new Date().toISOString()}] Error updating vendor: ${error.message}`;
        clearMessage('error');
      } finally {
        setLoading(false);
      }
    }

    // Delete vendor
    async function deleteVendor(id) {
      if (!window.supabaseClient) {
        console.error('Supabase client not initialized');
        return;
      }
      console.log('Deleting vendor:', id);
      setLoading(true);
      try {
        const { error } = await window.supabaseClient
          .from('vendors')
          .delete()
          .eq('id', id);
        if (error) throw error;
        console.log('Vendor deleted:', id);
        document.getElementById('message').textContent = `[${new Date().toISOString()}] Vendor deleted: ${id}`;
        clearMessage('message');
        await loadVendors();
      } catch (error) {
        console.error('Error deleting vendor:', error.message);
        document.getElementById('error').textContent = `[${new Date().toISOString()}] Error deleting vendor: ${error.message}`;
        clearMessage('error');
      } finally {
        setLoading(false);
      }
    }

    // Add sale
    async function addSale(sale) {
      if (!window.supabaseClient) {
        console.error('Supabase client not initialized');
        return;
      }
      if (!sale.product_barcode || !sale.vendor_id || sale.quantity <= 0) {
        document.getElementById('error').textContent = `[${new Date().toISOString()}] Product barcode, vendor, and quantity (>0) are required.`;
        clearMessage('error');
        return;
      }
      console.log('Adding sale:', sale);
      setLoading(true);
      try {
        const { data: product, error: productError } = await window.supabaseClient
          .from('products')
          .select('barcode, stock')
          .eq('barcode', sale.product_barcode)
          .single();
        if (productError || !product) {
          throw new Error('Product not found');
        }
        if (product.stock < sale.quantity) {
          throw new Error(`Insufficient stock: ${product.stock} available`);
        }
        const { data: saleData, error } = await window.supabaseClient
          .from('sales')
          .insert([sale])
          .select();
        if (error) throw error;
        await window.supabaseClient
          .from('products')
          .update({ stock: product.stock - sale.quantity })
          .eq('barcode', sale.product_barcode);
        console.log('Sale added:', JSON.stringify(saleData, null, 2));
        document.getElementById('message').textContent = `[${new Date().toISOString()}] Sale recorded for ${sale.product_barcode}`;
        clearMessage('message');
        await loadSales();
      } catch (error) {
        console.error('Error adding sale:', error.message);
        document.getElementById('error').textContent = `[${new Date().toISOString()}] Failed to add sale: ${error.message}`;
        clearMessage('error');
      } finally {
        setLoading(false);
      }
    }

    // Delete sale
    async function deleteSale(id) {
      if (!window.supabaseClient) {
        console.error('Supabase client not initialized');
        return;
      }
      console.log('Deleting sale:', id);
      setLoading(true);
      try {
        const { error } = await window.supabaseClient
          .from('sales')
          .delete()
          .eq('id', id);
        if (error) throw error;
        console.log('Sale deleted:', id);
        document.getElementById('message').textContent = `[${new Date().toISOString()}] Sale deleted: ${id}`;
        clearMessage('message');
        await loadSales();
      } catch (error) {
        console.error('Error deleting sale:', error.message);
        document.getElementById('error').textContent = `[${new Date().toISOString()}] Error deleting sale: ${error.message}`;
        clearMessage('error');
      } finally {
        setLoading(false);
      }
    }

    // Set up real-time subscriptions
    function setupRealtime() {
      const channels = [
        {
          name: 'products',
          table: 'products',
          callback: loadProducts
        },
        {
          name: 'vendors',
          table: 'vendors',
          callback: loadVendors
        },
        {
          name: 'sales',
          table: 'sales',
          callback: loadSales
        }
      ];

      channels.forEach(({ name, table, callback }) => {
        const channel = window.supabaseClient
          .channel(name)
          .on(
            'postgres_changes',
            { event: '*', schema: 'public', table },
            (payload) => {
              console.log(`Realtime update (${table}):`, payload);
              callback();
            }
          )
          .subscribe((status) => {
            console.log(`Subscription status (${table}):`, status);
            if (status === 'SUBSCRIBED') {
              console.log(`Successfully subscribed to ${table} changes`);
            } else if (status === 'CLOSED' || status === 'CHANNEL_ERROR') {
              console.error(`Subscription to ${table} failed, status:`, status);
            }
          });
      });
    }

    // Run on page load
    document.addEventListener('DOMContentLoaded', () => {
      testSupabase();
      loadProducts();
      loadVendors();
      loadSales();
      setupRealtime();
    });
  </script>
</body>
</html>
