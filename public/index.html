<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supabase App</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #products { margin-top: 20px; }
    .product { border: 1px solid #ccc; padding: 10px; margin: 5px 0; display: flex; justify-content: space-between; align-items: center; }
    .error { color: red; }
    .note { color: #555; font-size: 0.9em; }
    button { margin-left: 10px; }
  </style>
</head>
<body>
  <h1>Supabase Test App</h1>
  <button onclick="addProduct({ barcode: '123456789-' + Date.now(), name: 'Test Item', price: 10.99, stock: 50 })">Add Product</button>
  <p class="note">Note: Barcodes must be unique. A timestamp is added to ensure uniqueness.</p>
  <div id="products"></div>
  <div id="error" class="error"></div>

  <!-- Load Supabase SDK from jsDelivr -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script>
    // Initialize Supabase client
    if (typeof supabase === 'undefined') {
      console.error('Supabase SDK not loaded');
      throw new Error('Supabase SDK not loaded');
    }

    const { createClient } = supabase;
    window.supabaseClient = createClient(
      'https://aouduygmcspiqauhrabx.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFvdWR1eWdtY3NwaXFhdWhyYWJ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUyNTM5MzAsImV4cCI6MjA2MDgyOTkzMH0.s8WMvYdE9csSb1xb6jv84aiFBBU_LpDi1aserTQDg-k'
    );
    console.log('Supabase Client Initialized:', window.supabaseClient);

    // Test Supabase connection
    async function testSupabase() {
      if (!window.supabaseClient) {
        console.error('Supabase client not initialized');
        return;
      }
      console.log('Supabase client is ready:', window.supabaseClient);
    }

    // Load products
    async function loadProducts() {
      if (!window.supabaseClient) {
        console.error('Supabase client not initialized');
        return;
      }
      try {
        const { data, error } = await window.supabaseClient.from('products').select('*');
        if (error) throw error;
        console.log('Products:', data);
        // Display products in the UI
        const productsDiv = document.getElementById('products');
        productsDiv.innerHTML = data.length
          ? data.map(p => `
              <div class="product">
                <span>${p.name} (Barcode: ${p.barcode}): $${p.price} (Stock: ${p.stock})</span>
                <div>
                  <button onclick="updateProduct('${p.barcode}', { stock: ${p.stock + 10} })">Increase Stock (+10)</button>
                  <button onclick="deleteProduct('${p.barcode}')">Delete</button>
                </div>
              </div>
            `).join('')
          : '<p>No products found.</p>';
      } catch (error) {
        console.error('Error loading products:', error.message);
        const errorMessage = error.message.includes('Invalid API key')
          ? 'Failed to load products: Invalid API key or missing RLS policies. Check Supabase settings.'
          : `Error loading products: ${error.message}`;
        document.getElementById('error').textContent = errorMessage;
      }
    }

    // Add product
    async function addProduct(product) {
      if (!window.supabaseClient) {
        console.error('Supabase client not initialized');
        return;
      }
      console.log('Adding product:', product);
      try {
        const { data, error } = await window.supabaseClient
          .from('products')
          .insert([product])
          .select(); // Return the inserted data
        if (error) throw error;
        console.log('Product added:', JSON.stringify(data, null, 2));
        // Refresh products list
        loadProducts();
      } catch (error) {
        console.error('Error adding product:', error.message);
        let errorMessage = error.message.includes('Invalid API key')
          ? 'Failed to add product: Invalid API key or missing RLS policies. Check Supabase settings.'
          : `Error adding product: ${error.message}`;
        if (error.message.includes('duplicate key value violates unique constraint')) {
          errorMessage = 'Failed to add product: Barcode already exists. Please use a unique barcode.';
        }
        document.getElementById('error').textContent = errorMessage;
      }
    }

    // Update product
    async function updateProduct(barcode, updates) {
      if (!window.supabaseClient) {
        console.error('Supabase client not initialized');
        return;
      }
      console.log('Updating product:', barcode, updates);
      try {
        const { data, error } = await window.supabaseClient
          .from('products')
          .update(updates)
          .eq('barcode', barcode)
          .select();
        if (error) throw error;
        console.log('Product updated:', JSON.stringify(data, null, 2));
        // Refresh products list
        loadProducts();
      } catch (error) {
        console.error('Error updating product:', error.message);
        document.getElementById('error').textContent = `Error updating product: ${error.message}`;
      }
    }

    // Delete product
    async function deleteProduct(barcode) {
      if (!window.supabaseClient) {
        console.error('Supabase client not initialized');
        return;
      }
      console.log('Deleting product:', barcode);
      try {
        const { error } = await window.supabaseClient
          .from('products')
          .delete()
          .eq('barcode', barcode);
        if (error) throw error;
        console.log('Product deleted:', barcode);
        // Refresh products list
        loadProducts();
      } catch (error) {
        console.error('Error deleting product:', error.message);
        document.getElementById('error').textContent = `Error deleting product: ${error.message}`;
      }
    }

    // Run on page load
    document.addEventListener('DOMContentLoaded', () => {
      testSupabase();
      loadProducts();
    });
  </script>
</body>
</html>
