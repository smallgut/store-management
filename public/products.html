<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Products</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="common.js"></script>
</head>
<body id="lang-body" class="bg-gray-100">
  <nav class="bg-blue-500 p-4 text-white">
    <ul class="flex space-x-4">
      <li><a href="index.html" data-lang-key="nav-home">Home</a></li>
      <li><a href="analytics.html" data-lang-key="nav-analytics">Analytics</a></li>
      <li><a href="products.html" data-lang-key="nav-manage-products">Manage Products</a></li>
      <li><a href="vendors.html" data-lang-key="nav-manage-vendors">Manage Vendors</a></li>
      <li><a href="customer-sales.html" data-lang-key="nav-record-customer-sales">Record Customer Sales</a></li>
      <li><a href="vendor-loan-record.html" data-lang-key="nav-vendor-loan-record">Vendor Loan Record</a></li>
      <li><button id="toggle-language" data-lang-key="toggle-language">Toggle Language</button></li>
    </ul>
  </nav>

  <div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4" data-lang-key="manage-products-welcome">Welcome to Manage Products!</h1>

    <div id="loading" class="hidden text-center text-blue-500">Loading...</div>
    <div id="message" class="text-green-500"></div>
    <div id="error" class="text-red-500"></div>

    <div class="mb-4">
      <h2 class="text-xl font-semibold" data-lang-key="add-product">Add Product</h2>
      <form id="add-product-form" class="space-y-4">
        <div>
          <label for="product-barcode" data-lang-key="product-barcode">Product Barcode</label>
          <input id="product-barcode" type="text" class="border p-2 w-full" required>
        </div>
        <div>
          <label for="product-name" data-lang-key="product-name">Product Name</label>
          <input id="product-name" type="text" class="border p-2 w-full" required>
        </div>
        <div>
          <label for="stock" data-lang-key="stock">Stock</label>
          <input id="stock" type="number" class="border p-2 w-full" required min="0">
        </div>
        <div>
          <label for="units" data-lang-key="units">Units</label>
          <select id="units" class="border p-2 w-full" required>
            <option value="" data-lang-key="select-unit">-- Select Unit --</option>
            <option value="box" data-lang-key="unit-box">box</option>
            <option value="Taijin" data-lang-key="unit-taijin">Taijin</option>
          </select>
        </div>
        <div>
          <label for="buy-in-price" data-lang-key="buy-in-price">Buy-In Price</label>
          <input id="buy-in-price" type="number" step="0.01" class="border p-2 w-full" required min="0">
        </div>
        <button type="submit" data-lang-key="add-product" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Add Product</button>
      </form>
    </div>

    <h2 class="text-xl font-semibold" data-lang-key="manage-products">Manage Products</h2>
    <table id="products-table" class="w-full border-collapse border">
      <thead>
        <tr class="bg-gray-200">
          <th class="border p-2" data-lang-key="product-barcode">Product Barcode</th>
          <th class="border p-2" data-lang-key="product-name">Product Name</th>
          <th class="border p-2" data-lang-key="stock">Stock</th>
          <th class="border p-2" data-lang-key="units">Units</th>
          <th class="border p-2" data-lang-key="batch-no">Batch No.</th>
          <th class="border p-2" data-lang-key="buy-in-price">Buy-In Price</th>
          <th class="border p-2" data-lang-key="inventory-value">Inventory Value</th>
          <th class="border p-2" data-lang-key="actions">Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
<script>
  document.getElementById("add-product-form").addEventListener("submit", async (e) => {
    e.preventDefault();

    const barcode = document.getElementById("product-barcode").value.trim();
    const name = document.getElementById("product-name").value.trim();
    const stock = parseInt(document.getElementById("stock").value, 10);
    const units = document.getElementById("units").value;
    const buyInPrice = parseFloat(document.getElementById("buy-in-price").value);
    const vendorId = 31; // ⚠️ TODO: replace with dropdown if you want dynamic vendor selection

    if (!barcode || !name || isNaN(stock) || !units || isNaN(buyInPrice)) {
      alert("⚠️ Please fill in all product fields");
      return;
    }

    const client = await ensureSupabaseClient();

    // 1. Insert product
    const { data: product, error: productError } = await client
      .from("products")
      .insert([{
        barcode,
        name,
        stock,
        price: buyInPrice,
        vendor_id: vendorId,
        units
      }])
      .select("id")
      .single();

    if (productError) {
      console.error("❌ Failed to insert product:", productError);
      alert("Failed to add product");
      return;
    }

    // 2. Generate batch number from today (DDMMYY)
    const now = new Date();
    const dd = String(now.getDate()).padStart(2, "0");
    const mm = String(now.getMonth() + 1).padStart(2, "0");
    const yy = String(now.getFullYear()).slice(-2);
    const batchNumber = `${dd}${mm}${yy}`;

    // 3. Insert initial batch
    const { error: batchError } = await client
      .from("product_batches")
      .insert([{
        product_id: product.id,
        vendor_id: vendorId,
        batch_number: batchNumber,
        quantity: stock,
        remaining_quantity: stock,
        buy_in_price: buyInPrice,
        created_at: new Date().toISOString()
      }]);

    if (batchError) {
      console.error("❌ Failed to insert batch:", batchError);
      alert("Product added, but batch creation failed.");
      return;
    }

    alert("✅ Product and initial batch added successfully");
    e.target.reset();
  });
</script>
  
</body>
</html>
