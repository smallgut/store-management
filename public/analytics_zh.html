<!DOCTYPE html>
<html lang="zh-Hant" id="lang-body" class="lang-zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>åˆ†æå ±è¡¨</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="common.js"></script>
</head>

<body class="bg-gray-100 p-4 transition-opacity duration-700 ease-in-out opacity-0">
  <!-- ğŸ”¹ å°èˆªåˆ— -->
  <nav class="bg-blue-500 p-4 text-white flex justify-between items-center">
    <ul class="flex space-x-4">
      <li><a href="index_zh.html">é¦–é </a></li>
      <li><a href="login_zh.html">ç™»å…¥</a></li>
      <li><a href="analytics_zh.html">åˆ†æ</a></li>
      <li><a href="products_zh.html">ç®¡ç†ç”¢å“</a></li>
      <li><a href="vendors_zh.html">ç®¡ç†ä¾›æ‡‰å•†</a></li>
      <li><a href="customer-sales_zh.html">è¨˜éŒ„é¡§å®¢éŠ·å”®</a></li>
      <li><a href="vendor-loan-record_zh.html">ä¾›æ‡‰å•†å€Ÿè²¨è¨˜éŒ„</a></li>
      <li><a href="product-catalog_zh.html">ç”¢å“ç›®éŒ„</a></li>
      
    </ul>
    <li><a href="analytics.html">English</a></li>
    <button id="logout-btn" class="bg-red-500 px-3 py-1 rounded hover:bg-red-600">ç™»å‡º</button>
  </nav>

  <h1 class="text-2xl font-bold mt-4 mb-6">åˆ†æå ±è¡¨</h1>

  <!-- ğŸ”¹ éŠ·å”®æ¦‚è¦½ -->
  <div class="bg-white p-4 rounded shadow mb-6">
    <h2 class="text-lg font-semibold mb-2 flex items-center justify-between">
      <span>éŠ·å”®æ¦‚è¦½</span>
      <div class="flex items-center space-x-2 text-sm">
        <label>å¾ï¼š</label>
        <input type="date" id="analytics-from" class="border rounded p-1">
        <label>è‡³ï¼š</label>
        <input type="date" id="analytics-to" class="border rounded p-1">
        <button id="filter-analytics"
          class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">
          å¥—ç”¨ç¯©é¸
        </button>
      </div>
    </h2>

    <div id="charts-container" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
      <div>
        <h3 class="text-md font-semibold mb-1">æ¯æ—¥éŠ·å”®ç¸½é¡</h3>
        <canvas id="salesByDayChart" height="150"></canvas>
      </div>
      <div>
        <h3 class="text-md font-semibold mb-1">å„ç”¢å“éŠ·å”®ç¸½é¡</h3>
        <canvas id="salesByProductChart" height="150"></canvas>
      </div>
    </div>
  </div>

  <!-- ğŸ”¹ éŠ·å”®è³‡æ–™è¡¨ -->
  <div id="sales-data-section" class="bg-white p-4 rounded shadow mt-6">
    <h2 class="text-lg font-semibold mb-2">éŠ·å”®è³‡æ–™</h2>
    <table id="analytics-table" class="w-full border-collapse border border-gray-300">
      <thead>
        <tr class="bg-gray-200">
          <th class="border p-2">è¨‚å–®ç·¨è™Ÿ</th>
          <th class="border p-2">å®¢æˆ¶åç¨±</th>
          <th class="border p-2">éŠ·å”®æ—¥æœŸ</th>
          <th class="border p-2">ç¸½é¡</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- ğŸ”¹ ä¾›æ‡‰å•†é€²è²¨å ±è¡¨ -->
  <div id="vendor-report-section" class="bg-white p-4 rounded shadow mt-8">
    <h2 class="text-lg font-semibold mb-4">ä¾›æ‡‰å•†é€²è²¨å ±è¡¨</h2>
    <div class="flex flex-wrap gap-4 mb-4">
      <div>
        <label class="block text-sm font-medium mb-1">ä¾›æ‡‰å•†</label>
        <select id="vendor-report-select" class="border rounded p-2 min-w-[200px]"></select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">å¾</label>
        <input type="date" id="vendor-report-from" class="border rounded p-2" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">è‡³</label>
        <input type="date" id="vendor-report-to" class="border rounded p-2" />
      </div>
      <div class="flex items-end">
        <button onclick="runVendorPurchaseReport()"
          class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
          ğŸ” ç”Ÿæˆå ±è¡¨
        </button>
      </div>
    </div>

    <table id="vendor-report-table" class="w-full border-collapse border border-gray-300">
      <thead class="bg-gray-200">
        <tr>
          <th class="border p-2">ä¾›æ‡‰å•†</th>
          <th class="border p-2">ç”¢å“</th>
          <th class="border p-2">æ‰¹æ¬¡è™Ÿ</th>
          <th class="border p-2">é€²è²¨åƒ¹</th>
          <th class="border p-2">é€²è²¨æ•¸é‡</th>
          <th class="border p-2">å·²å”®å‡º</th>
          <th class="border p-2">å·²å€Ÿå‡º</th>
          <th class="border p-2">å‰©é¤˜</th>
          <th class="border p-2">å°è¨ˆ</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="8" class="p-4 text-center text-gray-500">æš«ç„¡è³‡æ–™</td></tr>
      </tbody>
    </table>

    <div class="flex justify-between items-center mt-4">
      <div class="font-semibold">
        æ‡‰ä»˜ç¸½é¡ï¼š$<span id="vendor-report-total">0.00</span>
      </div>
      <button id="export-vendor-report"
        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow">
        ğŸ“„ åŒ¯å‡º PDF
      </button>
    </div>
  </div>

  <!-- ğŸ”¹ ä¾›æ‡‰å•†å€Ÿè²¸å ±è¡¨ -->
  <div id="vendor-loan-report-section" class="bg-white p-4 rounded shadow mt-8">
    <h2 class="text-lg font-semibold mb-4">ä¾›æ‡‰å•†å€Ÿè²¸å ±è¡¨</h2>
    <div class="flex flex-wrap gap-4 mb-4">
      <div>
        <label class="block text-sm font-medium mb-1">ä¾›æ‡‰å•†</label>
        <select id="vendor-loan-select" class="border rounded p-2 min-w-[200px]"></select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">å¾</label>
        <input type="date" id="vendor-loan-from" class="border rounded p-2" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">è‡³</label>
        <input type="date" id="vendor-loan-to" class="border rounded p-2" />
      </div>
      <div class="flex items-end">
        <button onclick="runVendorLoanReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
          ğŸ” ç”Ÿæˆå ±è¡¨
        </button>
      </div>
    </div>

    <table id="vendor-loan-report-table" class="w-full border-collapse border border-gray-300">
      <thead class="bg-gray-200">
        <tr>
          <th class="border p-2">ä¾›æ‡‰å•†</th>
          <th class="border p-2">ç”¢å“</th>
          <th class="border p-2">æ‰¹æ¬¡è™Ÿ</th>
          <th class="border p-2">æ•¸é‡</th>
          <th class="border p-2">å”®åƒ¹</th>
          <th class="border p-2">ç¸½é¡</th>
          <th class="border p-2">å€Ÿå‡ºæ—¥æœŸ</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="6" class="p-4 text-center text-gray-500">æš«ç„¡è³‡æ–™</td></tr>
      </tbody>
    </table>

    <div class="flex justify-between items-center mt-4">
      <div class="font-semibold">
        å€Ÿè²¸ç¸½é¡ï¼š$<span id="vendor-loan-total">0.00</span>
      </div>
      <button id="export-vendor-loan-report"
        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow">
        ğŸ“„ åŒ¯å‡º PDF
      </button>
    </div>
  </div>

  <script>

    
document.addEventListener("DOMContentLoaded", async () => {
  console.log("ğŸ“Š åˆå§‹åŒ–åˆ†æå ±è¡¨é é¢...");
  const supabase = await ensureSupabaseClient();

  const { data: { session } } = await supabase.auth.getSession();
  if (!session) {
    window.location.href = "login_zh.html";
    return;
  }

  // ğŸš¨ ROLE-BASED ACCESS CHECK
  const role = await getUserRole();
  if (!role || (role !== "admin" && role !== "manager")) {
    alert("Access denied! You donâ€™t have permission to view analytics.");
    window.location.href = "index_zh.html";
    return;
  }

  document.getElementById("logout-btn")?.addEventListener("click", async () => {
    await supabase.auth.signOut();
    window.location.href = "login_zh.html";
  });

  applyTranslations();
  applyRoleRestrictions(role);
  
  try {
    await loadAnalyticsCharts();
    await loadSalesTable();
    await loadVendorsForReport();
  } catch (err) {
    console.error("âŒ è¼‰å…¥åˆ†æå ±è¡¨å¤±æ•—", err);
  }

  document.getElementById("filter-analytics")?.addEventListener("click", async () => {
    fadeOutSection("#charts-container");
    fadeOutSection("#sales-data-section");
    await loadAnalyticsCharts();
    await loadSalesTable();
    setTimeout(() => {
      fadeInSection("#charts-container");
      fadeInSection("#sales-data-section");
    }, 200);
  });
});

function fadeOutSection(selector) {
  const el = document.querySelector(selector);
  if (!el) return;
  el.style.transition = "opacity 0.4s ease";
  el.style.opacity = 0.2;
}
function fadeInSection(selector) {
  const el = document.querySelector(selector);
  if (!el) return;
  el.style.transition = "opacity 0.6s ease";
  el.style.opacity = 1;
}

async function loadAnalyticsCharts() {
  const from = document.getElementById("analytics-from")?.value || null;
  const to   = document.getElementById("analytics-to")?.value || null;
  const byDay = await analyticsSalesByDay(from, to);
  const byProduct = await analyticsSalesByProduct(from, to);
  renderSalesByDayChart(byDay);
  renderSalesByProductChart(byProduct);
}

let salesByDayChart, salesByProductChart;

function renderSalesByDayChart(data) {
  const ctx = document.getElementById("salesByDayChart").getContext("2d");
  if (salesByDayChart) salesByDayChart.destroy();
  salesByDayChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: data.map(d => d.day),
      datasets: [{
        label: "æ¯æ—¥éŠ·å”®ç¸½é¡",
        data: data.map(d => d.total),
        borderColor: "blue",
        backgroundColor: "rgba(59,130,246,0.2)",
        tension: 0.2
      }]
    },
    options: {
      scales: {
        x: { title: { display: true, text: "æ—¥æœŸ" } },
        y: { title: { display: true, text: "ç¸½é¡ ($)" } }
      }
    }
  });
}

function renderSalesByProductChart(data) {
  const ctx = document.getElementById("salesByProductChart").getContext("2d");
  if (salesByProductChart) salesByProductChart.destroy();
  salesByProductChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: data.map(d => d.product),
      datasets: [{
        label: "ç”¢å“éŠ·å”®ç¸½é¡",
        data: data.map(d => d.total),
        backgroundColor: "rgba(16,185,129,0.6)"
      }]
    },
    options: {
      indexAxis: "y",
      scales: {
        x: { title: { display: true, text: "ç¸½é¡ ($)" } },
        y: { title: { display: true, text: "ç”¢å“" } }
      }
    }
  });
}

async function loadSalesTable() {
  const supabase = await ensureSupabaseClient();
  const from = document.getElementById("analytics-from")?.value || null;
  const to = document.getElementById("analytics-to")?.value || null;

  let query = supabase
    .from("customer_sales")
    .select("id, customer_name, sale_date, total")
    .order("sale_date", { ascending: false });

  if (from) query = query.gte("sale_date", from);
  if (to) query = query.lte("sale_date", to);
  query = query.limit(50);
  const { data, error } = await query;

  const tbody = document.querySelector("#analytics-table tbody");
  tbody.innerHTML = "";

  if (error) {
    console.error("âŒ è¼‰å…¥éŠ·å”®è³‡æ–™å¤±æ•—", error);
    tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-gray-500">è¼‰å…¥å¤±æ•—ã€‚</td></tr>`;
    return;
  }

  if (!data?.length) {
    tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-gray-500">ç„¡éŠ·å”®è³‡æ–™ã€‚</td></tr>`;
    return;
  }

  data.forEach(row => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="border p-2">#${row.id}</td>
      <td class="border p-2">${row.customer_name || "-"}</td>
      <td class="border p-2">${new Date(row.sale_date).toLocaleDateString("zh-TW")}</td>
      <td class="border p-2 text-right">${Number(row.total).toFixed(2)}</td>
    `;
    tbody.appendChild(tr);
  });
}

    async function loadVendorsForReport() {
  const supabase = await ensureSupabaseClient();
  const { data, error } = await supabase.from("vendors").select("id, name").order("name");

  const vendorSelect = document.getElementById("vendor-report-select");
  const vendorLoanSelect = document.getElementById("vendor-loan-select");

  if (error) {
    console.error("âŒ ç„¡æ³•è¼‰å…¥ä¾›æ‡‰å•†æ¸…å–®:", error);
    return;
  }

  if (vendorSelect) {
    vendorSelect.innerHTML = `<option value="">-- è«‹é¸æ“‡ä¾›æ‡‰å•† --</option>`;
    (data || []).forEach(v => {
      const opt = document.createElement("option");
      opt.value = v.id;
      opt.textContent = v.name;
      vendorSelect.appendChild(opt);
    });
  }

  if (vendorLoanSelect) {
    vendorLoanSelect.innerHTML = `<option value="">-- è«‹é¸æ“‡ä¾›æ‡‰å•† --</option>`;
    (data || []).forEach(v => {
      const opt = document.createElement("option");
      opt.value = v.id;
      opt.textContent = v.name;
      vendorLoanSelect.appendChild(opt);
    });
  }
}
async function runVendorPurchaseReport() {
  const vendorId = document.getElementById("vendor-report-select").value || null;
  const from = document.getElementById("vendor-report-from").value || null;
  const to = document.getElementById("vendor-report-to").value || null;

  if (!from && !to && !vendorId) {
    return alert("âš ï¸ è«‹é¸æ“‡æ—¥æœŸç¯„åœæˆ–ä¾›æ‡‰å•†ã€‚");
  }

  fadeOutSection("#vendor-report-section");

  try {
    const report = await analyticsVendorPurchases(vendorId, from, to);
    const tbody = document.querySelector("#vendor-report-table tbody");
    tbody.innerHTML = "";

    if (!report.rows.length) {
      tbody.innerHTML = `<tr><td colspan="8" class="p-4 text-center text-gray-500">ç„¡è³‡æ–™ã€‚</td></tr>`;
      document.getElementById("vendor-report-total").textContent = "0.00";
      return;
    }

    report.rows.forEach(r => {
      tbody.insertAdjacentHTML("beforeend", `
        <tr>
        <td class="border p-2">${r.vendor}</td>
          <td class="border p-2">${r.product}</td>
          <td class="border p-2">${r.batch}</td>
          <td class="border p-2">${r.price}</td>
          <td class="border p-2">${r.qty}</td>
          <td class="border p-2">${r.sold}</td>
          <td class="border p-2">${r.loaned}</td>
          <td class="border p-2">${r.remaining}</td>
          <td class="border p-2">${r.subtotal}</td>
        </tr>
      `);
    });

    document.getElementById("vendor-report-total").textContent = report.total.toFixed(2);
  } catch (err) {
    console.error("âŒ ç„¡æ³•ç”Ÿæˆé€²è²¨å ±è¡¨", err);
    alert("é€²è²¨å ±è¡¨è¼‰å…¥å¤±æ•—ã€‚");
  } finally {
    fadeInSection("#vendor-report-section");
  }
}

function applyRoleRestrictions(role) {
  if (role === "staff") {
    document.querySelector('a[href="analytics_zh.html"]')?.parentElement.remove();
    document.querySelector('a[href="vendor-loan-record_zh.html"]')?.parentElement.remove();
  }
}
    
function exportVendorReportPDF() {
  const table = document.getElementById("vendor-report-table");
  const vendorSelect = document.getElementById("vendor-report-select");
  const vendorName = vendorSelect.options[vendorSelect.selectedIndex]?.text || "æœªçŸ¥ä¾›æ‡‰å•†";
  const total = document.getElementById("vendor-report-total").textContent || "0.00";
  const rows = Array.from(table.querySelectorAll("tbody tr")).map(tr =>
    Array.from(tr.children).map(td => td.textContent.trim())
  );
  if (!rows.length || rows[0][0] === "æš«ç„¡è³‡æ–™") return alert("âš ï¸ æ²’æœ‰å¯åŒ¯å‡ºçš„å ±è¡¨è³‡æ–™ã€‚");
  const html = `
    <html><head><title>${vendorName} - é€²è²¨å ±è¡¨</title>
    <style>
      @page { size: A4; margin: 15mm; }
      body { font-family: Arial, sans-serif; font-size: 12px; color: #222; }
      table { width: 100%; border-collapse: collapse; margin-top: 10px; }
      th, td { border: 1px solid #444; padding: 6px 8px; text-align: center; }
      th { background: #f0f0f0; font-weight: bold; }
      .summary { margin-top: 20px; text-align: right; font-weight: bold; }
      .footer { text-align: center; font-size: 10px; color: #888; margin-top: 30px; }
    </style></head>
    <body>
      <h1 style="text-align:center;">ä¾›æ‡‰å•†é€²è²¨å ±è¡¨</h1>
      <h3 style="text-align:center;">${vendorName}</h3>
      <table><thead><tr>
        <th>ä¾›æ‡‰å•†</th><th>ç”¢å“</th><th>æ‰¹æ¬¡è™Ÿ</th><th>é€²è²¨åƒ¹</th><th>é€²è²¨æ•¸é‡</th>
        <th>å·²å”®å‡º</th><th>å·²å€Ÿå‡º</th><th>å‰©é¤˜</th><th>å°è¨ˆ</th>
      </tr></thead><tbody>
      ${rows.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join("")}</tr>`).join("")}
      </tbody></table>
      <div class="summary">æ‡‰ä»˜ç¸½é¡ï¼š$${total}</div>
      <div class="footer">ç”Ÿæˆæ™‚é–“ï¼š${new Date().toLocaleString("zh-TW")} â€” POS ç³»çµ±</div>
    </body></html>`;
  const win = window.open("", "_blank");
  if (!win) return alert("âš ï¸ è«‹å…è¨±æ­¤ç¶²ç«™é–‹å•Ÿæ–°è¦–çª—ä»¥åŒ¯å‡º PDFã€‚");
  win.document.write(html);
  win.document.close();
  win.focus();
  setTimeout(() => win.print(), 500);
}
document.getElementById("export-vendor-report")?.addEventListener("click", exportVendorReportPDF);

function exportVendorLoanReportPDF() {
  const table = document.getElementById("vendor-loan-report-table");
  const vendorSelect = document.getElementById("vendor-loan-select");
  const vendorName = vendorSelect.options[vendorSelect.selectedIndex]?.text || "æœªçŸ¥ä¾›æ‡‰å•†";
  const total = document.getElementById("vendor-loan-total").textContent || "0.00";
  const rows = Array.from(table.querySelectorAll("tbody tr")).map(tr =>
    Array.from(tr.children).map(td => td.textContent.trim())
  );
  if (!rows.length || rows[0][0] === "æš«ç„¡è³‡æ–™") return alert("âš ï¸ æ²’æœ‰å¯åŒ¯å‡ºçš„å ±è¡¨è³‡æ–™ã€‚");
  const html = `
    <html><head><title>${vendorName} - å€Ÿè²¸å ±è¡¨</title>
    <style>
      @page { size: A4; margin: 15mm; }
      body { font-family: Arial, sans-serif; font-size: 12px; color: #222; }
      table { width: 100%; border-collapse: collapse; margin-top: 10px; }
      th, td { border: 1px solid #444; padding: 6px 8px; text-align: center; }
      th { background: #f0f0f0; font-weight: bold; }
      .summary { margin-top: 20px; text-align: right; font-weight: bold; }
      .footer { text-align: center; font-size: 10px; color: #888; margin-top: 30px; }
    </style></head>
    <body>
      <h1 style="text-align:center;">ä¾›æ‡‰å•†å€Ÿè²¸å ±è¡¨</h1>
      <h3 style="text-align:center;">${vendorName}</h3>
      <table><thead><tr>
        <th>ä¾›æ‡‰å•†</th><th>ç”¢å“</th><th>æ‰¹æ¬¡è™Ÿ</th><th>æ•¸é‡</th><th>å”®åƒ¹</th><th>ç¸½é¡</th><th>å€Ÿå‡ºæ—¥æœŸ</th>
      </tr></thead><tbody>
      ${rows.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join("")}</tr>`).join("")}
      </tbody></table>
      <div class="summary">å€Ÿè²¸ç¸½é¡ï¼š$${total}</div>
      <div class="footer">ç”Ÿæˆæ™‚é–“ï¼š${new Date().toLocaleString("zh-TW")} â€” POS ç³»çµ±</div>
    </body></html>`;
  const win = window.open("", "_blank");
  if (!win) return alert("âš ï¸ è«‹å…è¨±æ­¤ç¶²ç«™é–‹å•Ÿæ–°è¦–çª—ä»¥åŒ¯å‡º PDFã€‚");
  win.document.write(html);
  win.document.close();
  win.focus();
  setTimeout(() => win.print(), 500);
}
document.getElementById("export-vendor-loan-report")?.addEventListener("click", exportVendorLoanReportPDF);

window.addEventListener("load", () => {
  document.body.style.opacity = 0;
  document.body.style.transition = "opacity 0.8s ease";
  setTimeout(() => (document.body.style.opacity = 1), 100);
});
  </script>
</body>
</html>
