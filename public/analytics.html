<!DOCTYPE html>
<html lang="en" id="lang-body" class="lang-en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title data-lang-key="nav-analytics">Analytics</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="common.js"></script>
</head>

<body class="bg-gray-100 p-4">
  <!-- üîπ Navigation -->
  <nav class="bg-blue-500 p-4 text-white flex justify-between items-center">
    <ul class="flex space-x-4">
      <li><a href="index.html" data-lang-key="nav-home">Home</a></li>
      <li><a href="login.html" data-lang-key="nav-login">Login</a></li>
      <li><a href="analytics.html" data-lang-key="nav-analytics">Analytics</a></li>
      <li><a href="products.html" data-lang-key="nav-manage-products">Manage Products</a></li>
      <li><a href="vendors.html" data-lang-key="nav-manage-vendors">Manage Vendors</a></li>
      <li><a href="customer-sales.html" data-lang-key="nav-record-customer-sales">Record Customer Sales</a></li>
      <li><a href="vendor-loan-record.html" data-lang-key="nav-vendor-loan-record">Vendor Loan Record</a></li>
      <li><a href="product-catalog.html" data-lang-key="nav-product-catalog">Product Catalog</a></li>
      <li><button id="toggle-language" data-lang-key="toggle-language">Toggle Language</button></li>
    </ul>
    <button id="logout-btn" class="bg-red-500 px-3 py-1 rounded hover:bg-red-600">Logout</button>
  </nav>

  <h1 data-lang-key="analytics" class="text-2xl font-bold mt-4 mb-6">Analytics</h1>

  <!-- üîπ Sales Overview -->
  <div class="bg-white p-4 rounded shadow mb-6">
    <h2 class="text-lg font-semibold mb-2 flex items-center justify-between">
      <span>Sales Overview</span>
      <div class="flex items-center space-x-2 text-sm">
        <label>From:</label>
        <input type="date" id="analytics-from" class="border rounded p-1">
        <label>To:</label>
        <input type="date" id="analytics-to" class="border rounded p-1">
        <button id="filter-analytics" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">
          Apply Filter
        </button>
      </div>
    </h2>

    <div id="charts-container" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
      <div>
        <h3 class="text-md font-semibold mb-1">Total Sales by Day</h3>
        <canvas id="salesByDayChart" height="150"></canvas>
      </div>
      <div>
        <h3 class="text-md font-semibold mb-1">Total Sales by Product</h3>
        <canvas id="salesByProductChart" height="150"></canvas>
      </div>
    </div>
  </div>

  <!-- üîπ Sales Data Table -->
  <div id="sales-data-section" class="bg-white p-4 rounded shadow mt-6">
    <h2 class="text-lg font-semibold mb-2">Sales Data</h2>
    <table id="analytics-table" class="w-full border-collapse border border-gray-300">
      <thead>
        <tr class="bg-gray-200">
          <th class="border p-2">Order #</th>
          <th class="border p-2">Customer</th>
          <th class="border p-2">Sale Date</th>
          <th class="border p-2">Total</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- üîπ Vendor Purchase Report -->
  <div id="vendor-report-section" class="bg-white p-4 rounded shadow mt-8">
    <h2 class="text-lg font-semibold mb-4">Vendor Purchase Report</h2>
    <div class="flex flex-wrap gap-4 mb-4">
      <div>
        <label class="block text-sm font-medium mb-1">Vendor</label>
        <select id="vendor-report-select" class="border rounded p-2 min-w-[200px]"></select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">From</label>
        <input type="date" id="vendor-report-from" class="border rounded p-2" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">To</label>
        <input type="date" id="vendor-report-to" class="border rounded p-2" />
      </div>
      <div class="flex items-end">
        <button onclick="runVendorPurchaseReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
          üîç Run Report
        </button>
      </div>
    </div>

    <table id="vendor-report-table" class="w-full border-collapse border border-gray-300">
      <thead class="bg-gray-200">
        <tr>
          <th class="border p-2">Product</th>
          <th class="border p-2">Batch No.</th>
          <th class="border p-2">Buy-In Price</th>
          <th class="border p-2">Buy-In Qty</th>
          <th class="border p-2">Sold</th>
          <th class="border p-2">Loaned</th>
          <th class="border p-2">Remaining</th>
          <th class="border p-2">Subtotal</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="8" class="p-4 text-center text-gray-500">No data yet.</td></tr>
      </tbody>
    </table>

    <div class="flex justify-between items-center mt-4">
      <div class="font-semibold">Total Payable: $<span id="vendor-report-total">0.00</span></div>
      <button id="export-vendor-report" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow">
        üìÑ Export PDF
      </button>
    </div>
  </div>

  <!-- üîπ Vendor Loan Report -->
  <div id="vendor-loan-report-section" class="bg-white p-4 rounded shadow mt-8">
    <h2 class="text-lg font-semibold mb-4">Vendor Loan Report</h2>
    <div class="flex flex-wrap gap-4 mb-4">
      <div>
        <label class="block text-sm font-medium mb-1">Vendor</label>
        <select id="vendor-loan-select" class="border rounded p-2 min-w-[200px]"></select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">From</label>
        <input type="date" id="vendor-loan-from" class="border rounded p-2" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">To</label>
        <input type="date" id="vendor-loan-to" class="border rounded p-2" />
      </div>
      <div class="flex items-end">
        <button onclick="runVendorLoanReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
          üîç Run Report
        </button>
      </div>
    </div>

    <table id="vendor-loan-report-table" class="w-full border-collapse border border-gray-300">
      <thead class="bg-gray-200">
        <tr>
          <th class="border p-2">Product</th>
          <th class="border p-2">Batch No.</th>
          <th class="border p-2">Quantity</th>
          <th class="border p-2">Selling Price</th>
          <th class="border p-2">Total</th>
          <th class="border p-2">Loan Date</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="6" class="p-4 text-center text-gray-500">No data yet.</td></tr>
      </tbody>
    </table>

    <div class="flex justify-between items-center mt-4">
      <div class="font-semibold">Total Loan Amount: $<span id="vendor-loan-total">0.00</span></div>
      <button id="export-vendor-loan-report" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow">
        üìÑ Export PDF
      </button>
    </div>
  </div>

  <script>
/* ---------------------- üåê Initialization ---------------------- */
document.addEventListener("DOMContentLoaded", async () => {
  console.log("üìä Initializing Analytics page...");
  const supabase = await ensureSupabaseClient();
  const { data: { session } } = await supabase.auth.getSession();
  if (!session) return (window.location.href = "login.html");

  document.getElementById("logout-btn")?.addEventListener("click", async () => {
    await supabase.auth.signOut();
    window.location.href = "login.html";
  });

  applyTranslations();

  await loadAnalyticsCharts();
  await loadSalesTable();
  await loadVendorsForReport();

  document.getElementById("filter-analytics")?.addEventListener("click", async () => {
    fadeOutSection("#charts-container"); fadeOutSection("#sales-data-section");
    await loadAnalyticsCharts(); await loadSalesTable();
    setTimeout(() => { fadeInSection("#charts-container"); fadeInSection("#sales-data-section"); }, 200);
  });
});

/* ---------------------- üß© Vendor Loan Report ---------------------- */
async function runVendorLoanReport() {
  const supabase = await ensureSupabaseClient();
  const vendorId = document.getElementById("vendor-loan-select").value;
  const from = document.getElementById("vendor-loan-from").value;
  const to = document.getElementById("vendor-loan-to").value;

  if (!vendorId) return alert("Please select a vendor first.");
  fadeOutSection("#vendor-loan-report-section");

  let query = supabase.from("vendor_loans").select(`
    id, date, quantity, selling_price, batch_no,
    products(name)
  `).eq("vendor_id", vendorId).order("date", { ascending: false });

  if (from) query = query.gte("date", from);
  if (to) query = query.lte("date", to);

  const { data, error } = await query;
  const tbody = document.querySelector("#vendor-loan-report-table tbody");
  tbody.innerHTML = "";

  if (error) {
    console.error("‚ùå runVendorLoanReport failed", error);
    tbody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-gray-500">Error loading loan data.</td></tr>`;
    return fadeInSection("#vendor-loan-report-section");
  }

  if (!data?.length) {
    tbody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-gray-500">No loan data found.</td></tr>`;
    document.getElementById("vendor-loan-total").textContent = "0.00";
    return fadeInSection("#vendor-loan-report-section");
  }

  let totalLoan = 0;
  data.forEach(row => {
    const subtotal = Number(row.selling_price) * Number(row.quantity);
    totalLoan += subtotal;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="border p-2">${row.products?.name || "Unknown Product"}</td>
      <td class="border p-2">${row.batch_no || "-"}</td>
      <td class="border p-2 text-right">${row.quantity}</td>
      <td class="border p-2 text-right">${Number(row.selling_price).toFixed(2)}</td>
      <td class="border p-2 text-right">${subtotal.toFixed(2)}</td>
      <td class="border p-2">${new Date(row.date).toLocaleDateString("zh-TW")}</td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById("vendor-loan-total").textContent = totalLoan.toFixed(2);
  fadeInSection("#vendor-loan-report-section");
}

/* ---------------------- üßæ Export Vendor Loan Report PDF ---------------------- */
function exportVendorLoanReportPDF() {
  const table = document.getElementById("vendor-loan-report-table");
  const vendorSelect = document.getElementById("vendor-loan-select");
  const vendorName = vendorSelect.options[vendorSelect.selectedIndex]?.text || "Unknown Vendor";
  const from = document.getElementById("vendor-loan-from").value || "(No Start Date)";
  const to = document.getElementById("vendor-loan-to").value || "(No End Date)";
  const total = document.getElementById("vendor-loan-total").textContent || "0.00";

  const rows = Array.from(table.querySelectorAll("tbody tr")).map(tr =>
    Array.from(tr.children).map(td => td.textContent.trim())
  );

  if (!rows.length || rows[0][0] === "No data yet." || rows[0][0] === "No loan data found.") 
    return alert("‚ö†Ô∏è No report data to export.");

  const html = `
    <html><head><title>Vendor Loan Report - ${vendorName}</title>
    <style>
      @page { size: A4; margin: 15mm; }
      body { font-family: Arial, sans-serif; font-size: 12px; color: #222; }
      table { width: 100%; border-collapse: collapse; margin-top: 10px; }
      th, td { border: 1px solid #444; padding: 6px 8px; text-align: center; }
      th { background: #f0f0f0; font-weight: bold; }
      .summary { margin-top: 20px; text-align: right; font-weight: bold; }
      .footer { text-align: center; font-size: 10px; color: #888; margin-top: 30px; }
    </style></head>
    <body>
      <h1 style="text-align:center;">Vendor Loan Report</h1>
      <h3 style="text-align:center;">${vendorName}<br>Period: ${from} ‚Üí ${to}</h3>
      <table><thead><tr>
        <th>Product</th><th>Batch No.</th><th>Quantity</th><th>Selling Price</th><th>Total</th><th>Loan Date</th>
      </tr></thead><tbody>
      ${rows.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join("")}</tr>`).join("")}
      </tbody></table>
      <div class="summary">Total Loan Amount: $${total}</div>
      <div class="footer">Generated on ${new Date().toLocaleString("zh-TW")} ‚Äî POS Analytics System</div>
    </body></html>`;

  const win = window.open("", "_blank");
  if (!win) return alert("‚ö†Ô∏è Please allow popups for this site to export PDF.");
  win.document.write(html);
  win.document.close();
  win.focus();
  setTimeout(() => win.print(), 500);
}
document.getElementById("export-vendor-loan-report")?.addEventListener("click", exportVendorLoanReportPDF);

/* ---------------------- ‚ú® Fade helpers ---------------------- */
function fadeOutSection(s){const e=document.querySelector(s);if(!e)return;e.style.transition="opacity 0.4s ease";e.style.opacity=0.2;}
function fadeInSection(s){const e=document.querySelector(s);if(!e)return;e.style.transition="opacity 0.6s ease";e.style.opacity=1;}

window.addEventListener("load",()=>{document.body.style.opacity=0;document.body.style.transition="opacity 0.8s ease";setTimeout(()=>document.body.style.opacity=1,100);});
  </script>
</body>
</html>
