<!DOCTYPE html>
<html lang="en" id="lang-body" class="lang-en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title data-lang-key="nav-analytics">Analytics</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="common.js"></script>
</head>
<body class="bg-gray-100 p-4">
  <!-- 🔹 Navigation -->
  <nav class="bg-blue-500 p-4 text-white flex justify-between items-center">
    <ul class="flex space-x-4">
      <li><a href="index.html" data-lang-key="nav-home">Home</a></li>
      <li><a href="login.html" data-lang-key="nav-login">Login</a></li>
      <li><a href="analytics.html" data-lang-key="nav-analytics">Analytics</a></li>
      <li><a href="products.html" data-lang-key="nav-manage-products">Manage Products</a></li>
      <li><a href="vendors.html" data-lang-key="nav-manage-vendors">Manage Vendors</a></li>
      <li><a href="customer-sales.html" data-lang-key="nav-record-customer-sales">Record Customer Sales</a></li>
      <li><a href="vendor-loan-record.html" data-lang-key="nav-vendor-loan-record">Vendor Loan Record</a></li>
      <li><a href="product-catalog.html" data-lang-key="nav-product-catalog">Product Catalog</a></li>
      <li><button id="toggle-language" data-lang-key="toggle-language">Toggle Language</button></li>
    </ul>
    <button id="logout-btn" class="bg-red-500 px-3 py-1 rounded hover:bg-red-600">Logout</button>
  </nav>

  <h1 data-lang-key="analytics" class="text-2xl font-bold mt-4 mb-6">Analytics</h1>

  <!-- 🔹 Charts -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    <div class="bg-white p-4 rounded shadow">
      <h2 class="text-lg font-semibold mb-2">Total Sales by Day</h2>
      <canvas id="salesByDayChart" height="150"></canvas>
    </div>
    <div class="bg-white p-4 rounded shadow">
      <h2 class="text-lg font-semibold mb-2">Total Sales by Product</h2>
      <canvas id="salesByProductChart" height="150"></canvas>
    </div>
  </div>

  <!-- 🔹 Existing Table -->
  <div class="bg-white p-4 rounded shadow">
    <h2 class="text-lg font-semibold mb-2">Sales Data</h2>
    <table id="analytics-table" class="w-full border-collapse border border-gray-300">
      <thead>
        <tr class="bg-gray-200">
          <th class="border p-2">Order #</th>
          <th class="border p-2">Customer</th>
          <th class="border p-2">Sale Date</th>
          <th class="border p-2">Total</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      console.log("📊 Initializing Analytics page...");
      const supabase = await ensureSupabaseClient();

      // 🔒 Auth Guard
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = "login.html";
        return;
      }

      // 🔑 Logout
      const logoutBtn = document.getElementById("logout-btn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", async () => {
          await supabase.auth.signOut();
          window.location.href = "login.html";
        });
      }

      applyTranslations();

      // 🔹 Load analytics
      try {
        const byDay = await analyticsSalesByDay();
        const byProduct = await analyticsSalesByProduct();

        // Render charts
        renderSalesByDayChart(byDay);
        renderSalesByProductChart(byProduct);

        // Also load latest sales into table
        loadSalesTable();
      } catch (err) {
        console.error("❌ Failed loading analytics", err);
      }
    });

    function renderSalesByDayChart(data) {
      const ctx = document.getElementById("salesByDayChart").getContext("2d");
      new Chart(ctx, {
        type: "line",
        data: {
          labels: data.map(d => d.day),
          datasets: [{
            label: "Total Sales",
            data: data.map(d => d.total),
            borderColor: "blue",
            backgroundColor: "rgba(59, 130, 246, 0.2)"
          }]
        }
      });
    }

    function renderSalesByProductChart(data) {
      const ctx = document.getElementById("salesByProductChart").getContext("2d");
      new Chart(ctx, {
        type: "bar",
        data: {
          labels: data.map(d => d.product),
          datasets: [{
            label: "Total Sales",
            data: data.map(d => d.total),
            backgroundColor: "rgba(16, 185, 129, 0.6)"
          }]
        }
      });
    }

    async function loadSalesTable() {
      const supabase = await ensureSupabaseClient();
      const { data, error } = await supabase
        .from("customer_sales")
        .select("id, customer_name, sale_date, total")
        .order("sale_date", { ascending: false })
        .limit(20);
      if (error) {
        console.error("❌ loadSalesTable failed", error);
        return;
      }
      const tbody = document.querySelector("#analytics-table tbody");
      tbody.innerHTML = "";
      (data || []).forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="border p-2">#${row.id}</td>
          <td class="border p-2">${row.customer_name || "-"}</td>
          <td class="border p-2">${new Date(row.sale_date).toLocaleDateString("zh-TW")}</td>
          <td class="border p-2">${Number(row.total).toFixed(2)}</td>
        `;
        tbody.appendChild(tr);
      });
    }
  </script>
</body>
</html>
